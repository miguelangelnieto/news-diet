{% extends "base.html" %}

{% block title %}Dashboard - News Diet{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header with Actions -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h2 class="text-2xl sm:text-3xl font-bold text-latte-text dark:text-frappe-text">Your News Feed</h2>
            <p class="text-latte-subtext0 dark:text-frappe-subtext0 mt-1">
                <span class="inline-flex items-center gap-3">
                    <span class="inline-flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full bg-latte-blue dark:bg-frappe-blue"></span>
                        <span id="unread-count">{{ unread_count }} unread</span>
                    </span>
                    {% if starred_count > 0 %}
                    <span class="inline-flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full bg-latte-yellow dark:bg-frappe-yellow"></span>
                        <span id="starred-count">{{ starred_count }} starred</span>
                    </span>
                    {% endif %}
                </span>
            </p>
        </div>
    </div>
    
    <!-- Processing indicator -->
    <div id="processing-indicator" class="hidden bg-latte-yellow/10 dark:bg-frappe-yellow/10 border border-latte-yellow/30 dark:border-frappe-yellow/30 rounded-xl p-4">
        <div class="flex items-center gap-3">
            <svg class="animate-spin h-5 w-5 text-latte-yellow dark:text-frappe-yellow" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-latte-yellow dark:text-frappe-yellow font-medium text-sm">Processing articles with AI... this might take a minute (CPU inference)</span>
        </div>
    </div>
    
    <!-- Tabs-style Filters -->
    <div class="bg-latte-mantle dark:bg-frappe-mantle rounded-2xl p-1.5 shadow-inner-sm overflow-x-auto no-scrollbar">
        <div class="flex items-center min-w-max gap-1">
            <a href="/" 
               id="tab-relevant"
               class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 {% if not show_all and not filter_unread and not filter_starred %}bg-white dark:bg-frappe-surface0 text-latte-blue dark:text-frappe-blue shadow-md scale-[1.02]{% else %}text-latte-subtext0 dark:text-frappe-subtext0 hover:bg-latte-surface0/50 dark:hover:bg-frappe-surface0/50 hover:text-latte-text dark:hover:text-frappe-text{% endif %}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg>
                Relevant ({{ min_relevance_score }}+)
            </a>
            <a href="/?show_all=true" 
               id="tab-all"
               class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 {% if show_all %}bg-white dark:bg-frappe-surface0 text-latte-blue dark:text-frappe-blue shadow-md scale-[1.02]{% else %}text-latte-subtext0 dark:text-frappe-subtext0 hover:bg-latte-surface0/50 dark:hover:bg-frappe-surface0/50 hover:text-latte-text dark:hover:text-frappe-text{% endif %}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
                All Posts
            </a>
            <a href="/?filter_unread=true" 
               id="tab-unread"
               class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 {% if filter_unread %}bg-white dark:bg-frappe-surface0 text-latte-blue dark:text-frappe-blue shadow-md scale-[1.02]{% else %}text-latte-subtext0 dark:text-frappe-subtext0 hover:bg-latte-surface0/50 dark:hover:bg-frappe-surface0/50 hover:text-latte-text dark:hover:text-frappe-text{% endif %}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                Unread
            </a>
            <a href="/?filter_starred=true" 
               id="tab-starred"
               class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 {% if filter_starred %}bg-white dark:bg-frappe-surface0 text-latte-blue dark:text-frappe-blue shadow-md scale-[1.02]{% else %}text-latte-subtext0 dark:text-frappe-subtext0 hover:bg-latte-surface0/50 dark:hover:bg-frappe-surface0/50 hover:text-latte-text dark:hover:text-frappe-text{% endif %}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                Starred
            </a>
        </div>
    </div>
    
    <!-- Articles List -->
    <div class="grid grid-cols-1 gap-4" id="articles-container">
        {% if articles %}
            {% for article in articles %}
            <article class="article-item group article-card bg-latte-mantle dark:bg-frappe-mantle rounded-2xl p-5 border border-transparent
                        {% if article.relevance_score >= 8 %}hover:border-latte-green/30 dark:hover:border-frappe-green/30 shadow-latte-green/5 dark:shadow-frappe-green/5{% elif article.relevance_score >= 5 %}hover:border-latte-yellow/30 dark:hover:border-frappe-yellow/30 shadow-latte-yellow/5 dark:shadow-frappe-yellow/5{% else %}hover:border-latte-overlay0/30 dark:hover:border-frappe-overlay0/30 shadow-latte-overlay0/5 dark:shadow-frappe-overlay0/5{% endif %}
                        {% if article.is_read %}opacity-60 saturate-[0.25]{% endif %}
                        hover:shadow-xl transition-all duration-300 relative overflow-hidden"
                 data-article-id="{{ article.id }}"
                 data-relevance="{{ article.relevance_score }}"
                 data-read="{{ 'true' if article.is_read else 'false' }}"
                 data-starred="{{ 'true' if article.is_starred else 'false' }}">
                
                <!-- Relevance Glow Effect -->
                <div class="absolute top-0 left-0 w-1.5 h-full 
                    {% if article.relevance_score >= 8 %}bg-latte-green dark:bg-frappe-green opacity-80{% elif article.relevance_score >= 5 %}bg-latte-yellow dark:bg-frappe-yellow opacity-80{% else %}bg-latte-overlay0 dark:bg-frappe-overlay0 opacity-40{% endif %}">
                </div>

                <div class="flex justify-between items-start gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start gap-3">
                            <!-- Star Button -->
                            <button 
                                type="button"
                                class="star-toggle shrink-0 mt-0.5 p-2 rounded-xl transition-all duration-300 {% if article.is_starred %}text-latte-yellow dark:text-frappe-yellow bg-latte-yellow/10 dark:bg-frappe-yellow/10{% else %}text-latte-overlay0 dark:text-frappe-overlay0 hover:text-latte-yellow dark:hover:text-frappe-yellow hover:bg-latte-yellow/5 dark:hover:bg-frappe-yellow/5{% endif %}"
                                data-article-id="{{ article.id }}"
                                data-is-starred="{{ 'true' if article.is_starred else 'false' }}"
                                title="{% if article.is_starred %}Unstar{% else %}Star{% endif %} article"
                            >
                                <svg class="w-5 h-5" fill="{% if article.is_starred %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                </svg>
                            </button>
                            <div class="flex-1 min-w-0">
                                <a href="/reader/{{ article.id }}" class="text-lg sm:text-xl font-bold text-latte-text dark:text-frappe-text hover:text-latte-blue dark:hover:text-frappe-blue transition-colors leading-snug line-clamp-2">
                                    {{ article.title }}
                                </a>
                                <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mt-2 text-xs sm:text-sm text-latte-subtext0 dark:text-frappe-subtext0">
                                    <div class="flex items-center gap-1.5">
                                        <span class="font-bold text-latte-blue dark:text-frappe-blue bg-latte-blue/5 dark:bg-frappe-blue/5 px-2 py-0.5 rounded-md">{{ article.source }}</span>
                                        <a href="{{ article.url }}" target="_blank" rel="noopener" class="p-1 hover:bg-latte-surface0 dark:hover:bg-frappe-surface0 rounded-md transition-all text-latte-overlay0 dark:text-frappe-overlay0 hover:text-latte-blue dark:hover:text-frappe-blue" title="Visit original site">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                            </svg>
                                        </a>
                                    </div>
                                    <span class="text-latte-overlay0 dark:text-frappe-overlay0">•</span>
                                    <span class="tabular-nums">{{ article.published_at.strftime('%b %d, %Y') }}</span>
                                    <span class="text-latte-overlay0 dark:text-frappe-overlay0">•</span>
                                    <span class="inline-flex items-center gap-1 font-bold
                                        {% if article.relevance_score >= 8 %}text-latte-green dark:text-frappe-green
                                        {% elif article.relevance_score >= 5 %}text-latte-yellow dark:text-frappe-yellow
                                        {% else %}text-latte-overlay0 dark:text-frappe-overlay0{% endif %}">
                                        {{ article.relevance_score }}/10
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Read/Unread Toggle -->
                    <button 
                        type="button"
                        class="read-toggle shrink-0 p-3 rounded-2xl transition-all duration-300
                               {% if article.is_read %}text-latte-green dark:text-frappe-green bg-latte-green/10 dark:bg-frappe-green/10 shadow-inner{% else %}text-latte-overlay0 dark:text-frappe-overlay0 bg-latte-base dark:bg-frappe-base hover:text-latte-blue dark:hover:text-frappe-blue shadow-sm{% endif %}"
                        data-article-id="{{ article.id }}"
                        data-is-read="{{ 'true' if article.is_read else 'false' }}"
                        title="{% if article.is_read %}Mark as unread{% else %}Mark as read{% endif %}"
                    >
                        <svg class="w-6 h-6" fill="{% if article.is_read %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </button>
                </div>
                
                {% if article.summary %}
                <p class="text-latte-subtext1 dark:text-frappe-subtext1 mt-4 ml-12 text-sm sm:text-base leading-relaxed line-clamp-4">{{ article.summary }}</p>
                {% endif %}
                
                {% if article.tags %}
                <div class="flex flex-wrap gap-1.5 mt-4 ml-12">
                    {% for tag in article.tags %}
                    <span class="px-2.5 py-1 bg-latte-base dark:bg-frappe-base text-latte-subtext0 dark:text-frappe-subtext0 text-xs font-bold rounded-lg border border-latte-surface0 dark:border-frappe-surface0">
                        #{{ tag.lower().replace(' ', '') }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </article>
            {% endfor %}
        {% else %}
            <div class="bg-latte-mantle dark:bg-frappe-mantle rounded-3xl p-16 text-center border-2 border-dashed border-latte-surface0 dark:border-frappe-surface0">
                <div class="w-20 h-20 mx-auto mb-6 rounded-3xl bg-latte-surface0 dark:bg-frappe-surface0 flex items-center justify-center text-latte-overlay0 dark:text-frappe-overlay0">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-latte-text dark:text-frappe-text">Your feed is empty</h3>
                <p class="mt-2 text-latte-subtext0 dark:text-frappe-subtext0 max-w-xs mx-auto">
                    {% if filter_starred %}
                        You haven't starred any articles yet.
                    {% elif filter_unread %}
                        You've caught up! No unread articles left.
                    {% elif not show_all %}
                        No articles match your relevance score ({{ min_relevance_score }}+).
                    {% else %}
                        No articles found in the database.
                    {% endif %}
                </p>
                <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-3">
                    <a href="/?show_all=true" class="inline-flex items-center gap-2 bg-latte-blue dark:bg-frappe-blue text-white px-6 py-3 rounded-xl font-bold shadow-md hover:shadow-lg transition-all active:scale-95">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
                        Clear Filters & Show All
                    </a>
                    <button onclick="refreshFeeds()" class="inline-flex items-center gap-2 bg-latte-surface0 dark:bg-frappe-surface0 text-latte-text dark:text-frappe-text px-6 py-3 rounded-xl font-bold hover:bg-latte-surface1 dark:hover:bg-frappe-surface1 transition-all active:scale-95">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Refresh Now
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
    // Event delegation for read toggle buttons
    document.addEventListener('DOMContentLoaded', function() {
        document.body.addEventListener('click', function(e) {
            // Check if clicked element is a read toggle button
            var readBtn = e.target.closest('.read-toggle');
            if (readBtn) {
                e.preventDefault();
                e.stopPropagation();
                
                var articleId = readBtn.dataset.articleId;
                var currentRead = readBtn.dataset.isRead;
                var newRead = currentRead === 'true' ? 'false' : 'true';
                
                toggleRead(articleId, newRead);
                return false;
            }
            
            // Check if clicked element is a star toggle button
            var starBtn = e.target.closest('.star-toggle');
            if (starBtn) {
                e.preventDefault();
                e.stopPropagation();
                
                var articleId = starBtn.dataset.articleId;
                var currentStarred = starBtn.dataset.isStarred;
                var newStarred = currentStarred === 'true' ? 'false' : 'true';
                
                toggleStar(articleId, newStarred);
                return false;
            }
        });
    });
    
    // Toggle read status with smooth animation
    function toggleRead(articleId, isRead) {
        var articleElement = document.querySelector('[data-article-id="' + articleId + '"]');
        if (!articleElement) return;
        
        // Check if we're in the "All" or "Starred" tab by looking at the URL
        var urlParams = new URLSearchParams(window.location.search);
        var isAllTab = urlParams.get('show_all') === 'true';
        var isStarredTab = urlParams.get('filter_starred') === 'true';
        
        fetch('/api/articles/' + articleId + '/read?is_read=' + isRead, { method: 'PATCH' })
            .then(function(response) {
                if (!response.ok) throw new Error('Failed to update');
                return response.json();
            })
            .then(function(data) { 
                if (data.success) {
                    // Update data attribute
                    articleElement.dataset.read = isRead;
                    
                    if (isRead === 'true') {
                        if (isAllTab || isStarredTab) {
                            // In "All" or "Starred" tab: just update styling, don't remove
                            // Add opacity and update button styling
                            articleElement.classList.add('opacity-60');
                            
                            // Update the read button
                            var readButton = articleElement.querySelector('.read-toggle');
                            if (readButton) {
                                // Add 'read' styling
                                var addClasses = [
                                    'text-latte-green', 'dark:text-frappe-green',
                                    'bg-latte-green/10', 'dark:bg-frappe-green/10',
                                    'hover:bg-latte-green/20', 'dark:hover:bg-frappe-green/20'
                                ];
                                readButton.classList.add(...addClasses);
                                
                                // Remove 'unread' styling
                                var removeClasses = [
                                    'text-latte-overlay0', 'dark:text-frappe-overlay0',
                                    'hover:bg-latte-surface0', 'dark:hover:bg-frappe-surface0'
                                ];
                                readButton.classList.remove(...removeClasses);
                                
                                var icon = readButton.querySelector('svg');
                                if (icon) icon.setAttribute('fill', 'currentColor');
                                readButton.title = 'Mark as unread';
                                readButton.setAttribute('aria-label', 'Mark as unread');
                                readButton.dataset.isRead = 'true';
                            }
                            
                            updateUnreadCount(-1);
                        } else {
                            // In other tabs: fade out and slide up (original behavior)
                            articleElement.style.opacity = '0';
                            articleElement.style.maxHeight = articleElement.offsetHeight + 'px';
                            articleElement.style.transform = 'translateX(-20px)';
                            
                            setTimeout(function() {
                                articleElement.style.maxHeight = '0';
                                articleElement.style.marginBottom = '0';
                                articleElement.style.paddingTop = '0';
                                articleElement.style.paddingBottom = '0';
                            }, 200);
                            
                            setTimeout(function() {
                                articleElement.remove();
                                updateUnreadCount(-1);
                            }, 500);
                        }
                    } else {
                        // Marking as unread - update UI without page reload
                        articleElement.classList.remove('opacity-60');
                        
                        // Update the read button
                        var readButton = articleElement.querySelector('.read-toggle');
                        if (readButton) {
                            // Remove 'read' styling
                            var removeClasses = [
                                'text-latte-green', 'dark:text-frappe-green',
                                'bg-latte-green/10', 'dark:bg-frappe-green/10',
                                'hover:bg-latte-green/20', 'dark:hover:bg-frappe-green/20'
                            ];
                            readButton.classList.remove(...removeClasses);
                            
                            // Add 'unread' styling
                            var addClasses = [
                                'text-latte-overlay0', 'dark:text-frappe-overlay0',
                                'hover:bg-latte-surface0', 'dark:hover:bg-frappe-surface0'
                            ];
                            readButton.classList.add(...addClasses);
                            
                            var icon = readButton.querySelector('svg');
                            if (icon) icon.setAttribute('fill', 'none');
                            readButton.title = 'Mark as read';
                            readButton.setAttribute('aria-label', 'Mark as read');
                            readButton.dataset.isRead = 'false';
                        }
                        
                        updateUnreadCount(1);
                    }
                } else {
                    showToast('Failed to update article', 'error');
                }
            })
            .catch(function(error) { 
                console.error('Error:', error);
                showToast('Network error. Please try again.', 'error');
            });
    }
    
    // Update unread count in header
    function updateUnreadCount(delta) {
        var unreadSpan = document.getElementById('unread-count');
        if (unreadSpan) {
            var currentText = unreadSpan.textContent.trim();
            var currentCount = parseInt(currentText.split(' ')[0]);
            var newCount = Math.max(0, currentCount + delta);
            unreadSpan.textContent = newCount + ' unread';
        }
    }
    
    // Toggle star status with smooth animation
    function toggleStar(articleId, isStarred) {
        var articleElement = document.querySelector('[data-article-id="' + articleId + '"]');
        if (!articleElement) return;
        
        fetch('/api/articles/' + articleId + '/star?is_starred=' + isStarred, { method: 'PATCH' })
            .then(function(response) {
                if (!response.ok) throw new Error('Failed to update');
                return response.json();
            })
            .then(function(data) { 
                if (data.success) {
                    // Update data attribute
                    articleElement.dataset.starred = isStarred;
                    
                    // Update the star button
                    var starButton = articleElement.querySelector('.star-toggle');
                    var starIcon = starButton.querySelector('svg');
                    
                    if (isStarred === 'true') {
                        starButton.classList.add('text-latte-yellow', 'dark:text-frappe-yellow');
                        starButton.classList.remove('text-latte-overlay0', 'dark:text-frappe-overlay0', 'hover:text-latte-yellow', 'dark:hover:text-frappe-yellow');
                        starIcon.setAttribute('fill', 'currentColor');
                        starButton.title = 'Unstar article';
                        starButton.setAttribute('aria-label', 'Unstar article');
                        starButton.dataset.isStarred = 'true';
                        updateStarredCount(1);
                    } else {
                        starButton.classList.remove('text-latte-yellow', 'dark:text-frappe-yellow');
                        starButton.classList.add('text-latte-overlay0', 'dark:text-frappe-overlay0', 'hover:text-latte-yellow', 'dark:hover:text-frappe-yellow');
                        starIcon.setAttribute('fill', 'none');
                        starButton.title = 'Star article';
                        starButton.setAttribute('aria-label', 'Star article');
                        starButton.dataset.isStarred = 'false';
                        updateStarredCount(-1);
                        
                        // In "Starred" tab: fade out and remove when unstarred
                        var urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('filter_starred') === 'true') {
                            articleElement.style.opacity = '0';
                            articleElement.style.maxHeight = articleElement.offsetHeight + 'px';
                            articleElement.style.transform = 'translateX(-20px)';
                            setTimeout(function() {
                                articleElement.style.maxHeight = '0';
                                articleElement.style.marginBottom = '0';
                                articleElement.style.paddingTop = '0';
                                articleElement.style.paddingBottom = '0';
                            }, 200);
                            setTimeout(function() { articleElement.remove(); }, 500);
                            return;
                        }
                    }
                    
                    // Add a little bounce animation
                    starButton.style.transform = 'scale(1.3)';
                    setTimeout(function() {
                        starButton.style.transform = 'scale(1)';
                    }, 200);
                } else {
                    showToast('Failed to star article', 'error');
                }
            })
            .catch(function(error) { 
                console.error('Error:', error);
                showToast('Network error. Please try again.', 'error');
            });
    }
    
    // Update starred count in header
    function updateStarredCount(delta) {
        var starredSpan = document.getElementById('starred-count');
        if (starredSpan) {
            var currentText = starredSpan.textContent.trim();
            var currentCount = parseInt(currentText.split(' ')[0]);
            var newCount = Math.max(0, currentCount + delta);
            starredSpan.textContent = newCount + ' starred';
            
            // Show/hide the starred count section
            var starredContainer = starredSpan.closest('.inline-flex.items-center.gap-1\\.5');
            if (starredContainer) {
                if (newCount === 0) {
                    starredContainer.style.display = 'none';
                } else {
                    starredContainer.style.display = 'inline-flex';
                }
            }
        }
    }

    // Refresh feeds
    async function refreshFeeds() {
        showToast('Fetching new articles...', 'info');
        try {
            const response = await fetch('/api/articles/refresh', { method: 'POST' });
            const result = await response.json();
            if (response.ok) {
                showToast(result.message || 'Feeds refreshed!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Failed to refresh feeds', 'error');
            }
        } catch (error) {
            showToast('Error refreshing feeds', 'error');
        }
    }
</script>
{% endblock %}
